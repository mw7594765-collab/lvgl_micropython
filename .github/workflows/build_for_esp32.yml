name: Build ESP32-C3 Legacy Firmware

on:
  workflow_dispatch:

jobs:
  build-c3:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libffi-dev git python3-pip
          pip3 install esptool

      - name: Setup MicroPython (v1.23.0) and LVGL (v9.2)
        run: |
          # 初始化 MicroPython 和 LVGL
          git submodule update --init --recursive lib/micropython
          git submodule update --init --recursive lib/lvgl
          
          # 切换 MicroPython 到 v1.23.0
          cd lib/micropython
          git fetch --tags
          git checkout v1.23.0
          git submodule update --init --recursive lib/berkeley-db-1.xx
          git submodule update --init --recursive lib/mbedtls
          git submodule update --init --recursive lib/micropython-lib
          cd ../..

          # 切换 LVGL 到 release/v9.2
          cd lib/lvgl
          git fetch --tags
          git checkout release/v9.2
          cd ../..

      - name: Setup ESP-IDF v5.2.2
        run: |
          # 删除 submodule 占位符，手动克隆指定版本
          rm -rf lib/esp-idf
          echo "Cloning ESP-IDF v5.2.2..."
          git clone -b v5.2.2 --recursive --depth 1 https://github.com/espressif/esp-idf.git lib/esp-idf
          
          # 安装工具链
          cd lib/esp-idf
          ./install.sh all
          cd ../..

      - name: Patch Builder Script for IDF v5.2.2
        run: |
          # 将构建脚本中的版本检查从 5.5.1 改为 5.2.2
          sed -i "s/IDF_VER = '5.5.1'/IDF_VER = '5.2.2'/g" builder/esp32.py
          # 验证修改
          grep "IDF_VER =" builder/esp32.py

      - name: Build Firmware for ESP32-C3
        shell: bash
        run: |
          export IDF_PATH=$(pwd)/lib/esp-idf
          source $IDF_PATH/export.sh
          
          # 编译命令
          python3 make.py esp32 \
            BOARD=ESP32_GENERIC_C3 \
            DISPLAY=st7789 \
            INDEV=all \
            --flash-size=4 \
            --optimize-size

      - name: Manual Firmware Merge and Check
        run: |
          # 定义构建目录 (v1.23.0 版本下的路径结构)
          BUILD_DIR="lib/micropython/ports/esp32/build-ESP32_GENERIC_C3"
          OUT_FILE="build/firmware.bin"
          
          echo "Checking build artifacts in $BUILD_DIR..."
          ls -R $BUILD_DIR || true
          
          if [ -f "$BUILD_DIR/micropython.bin" ]; then
            echo "Found micropython.bin, merging firmware..."
            
            # 创建 build 目录（如果不存在）
            mkdir -p build
            
            # 使用 esptool 手动合并固件
            # Offset 地址: Bootloader=0x0, Partition Table=0x8000, App=0x10000
            python3 -m esptool --chip esp32c3 merge_bin \
              -o $OUT_FILE \
              --flash_mode dio \
              --flash_size 4MB \
              --flash_freq 80m \
              0x0 "$BUILD_DIR/bootloader/bootloader.bin" \
              0x8000 "$BUILD_DIR/partition_table/partition-table.bin" \
              0x10000 "$BUILD_DIR/micropython.bin"
              
            echo "Firmware created at $OUT_FILE"
            ls -lh $OUT_FILE
          else
            echo "Error: micropython.bin not found! Build might have failed silently."
            exit 1
          fi

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: micropython-lvgl-esp32c3-st7789
          path: build/firmware.bin
