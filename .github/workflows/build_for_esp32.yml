name: Build ESP32-C3 Legacy Firmware

on:
  workflow_dispatch: # 允许手动触发构建

jobs:
  build-c3:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libffi-dev git python3-pip
          # 安装 esptool
          pip3 install esptool

      - name: Setup MicroPython (v1.23.0) and LVGL (v9.2)
        run: |
          # 初始化子模块
          git submodule update --init --recursive lib/micropython
          git submodule update --init --recursive lib/lvgl
          
          # 切换 MicroPython 到 v1.23.0
          cd lib/micropython
          git fetch --tags
          git checkout v1.23.0
          # 必须同步 micropython 内部的子模块 (如 berkeley-db, mbedtls 等)
          git submodule update --init --recursive lib/berkeley-db-1.xx
          git submodule update --init --recursive lib/mbedtls
          git submodule update --init --recursive lib/micropython-lib
          cd ../..

          # 切换 LVGL 到 release/v9.2
          cd lib/lvgl
          git fetch --tags
          git checkout release/v9.2
          cd ../..

      - name: Setup ESP-IDF v5.2.2
        run: |
          # 强制将 lib/esp-idf 切换到 v5.2.2
          cd lib/esp-idf
          git fetch --tags
          git checkout v5.2.2
          # 更新 IDF 子模块
          git submodule update --init --recursive
          # 运行安装脚本
          ./install.sh all
          cd ../..

      - name: Patch Builder Script for IDF v5.2.2
        # 修改 builder/esp32.py 中的版本检查，防止脚本因版本不匹配而报错或重新下载
        run: |
          sed -i "s/IDF_VER = '5.5.1'/IDF_VER = '5.2.2'/g" builder/esp32.py
          # 验证修改
          grep "IDF_VER =" builder/esp32.py

      - name: Build Firmware for ESP32-C3
        shell: bash
        run: |
          # 设置 IDF 环境变量
          export IDF_PATH=$(pwd)/lib/esp-idf
          source $IDF_PATH/export.sh
          
          # 运行编译命令
          # BOARD=ESP32_GENERIC_C3 是 C3 的标准板型名称
          # --flash-size=4 适配大多数 C3 开发板
          # DISPLAY=st7789 包含您需要的驱动
          python3 make.py esp32 \
            BOARD=ESP32_GENERIC_C3 \
            DISPLAY=st7789 \
            INDEV=all \
            --flash-size=4 \
            --optimize-size

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: micropython-lvgl-esp32c3-st7789
          path: build/*.bin
