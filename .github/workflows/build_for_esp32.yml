name: Custom Firmware Build

on:
  workflow_dispatch:
    inputs:
      esp_idf_version:
        description: 'ESP-IDF Version'
        required: true
        default: 'v5.2.2'
      lvgl_version:
        description: 'LVGL Version'
        required: true
        default: 'v9.1.0'
      micropython_version:
        description: 'MicroPython Version'
        required: true
        default: 'v1.24.1'
      board:
        description: 'Target Board (e.g.,ESP32_GENERIC_C3, ESP32_GENERIC, ESP32_GENERIC_S3)'
        required: true
        default: 'ESP32_GENERIC_C3'
      flash_size:
        description: 'Flash Size (e.g.,4, 8, 16)'
        required: true
        default: '4'

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Main Repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libffi-dev pkg-config libusb-1.0-0-dev

      - name: Prepare Lib Directory
        run: mkdir -p lib

      # 1. 克隆指定版本的 MicroPython
      - name: Clone MicroPython (${{ inputs.micropython_version }})
        run: |
          echo "Cloning MicroPython ${{ inputs.micropython_version }}..."
          git clone --depth 1 --branch ${{ inputs.micropython_version }} --recursive https://github.com/micropython/micropython.git lib/micropython

      # 2. 克隆指定版本的 LVGL
      - name: Clone LVGL (${{ inputs.lvgl_version }})
        run: |
          echo "Cloning LVGL ${{ inputs.lvgl_version }}..."
          git clone --depth 1 --branch ${{ inputs.lvgl_version }} https://github.com/lvgl/lvgl.git lib/lvgl

      # 3. 克隆指定版本的 ESP-IDF
      - name: Clone ESP-IDF (${{ inputs.esp_idf_version }})
        run: |
          echo "Cloning ESP-IDF ${{ inputs.esp_idf_version }}..."
          git clone --depth 1 --branch ${{ inputs.esp_idf_version }} --recursive https://github.com/espressif/esp-idf.git lib/esp-idf

      # 4. 获取 pycparser (这是构建所需的额外依赖，保持默认即可)
      - name: Clone pycparser
        run: |
          git clone --depth 1 https://github.com/eliben/pycparser.git lib/pycparser

      # 安装 ESP-IDF 工具链
      - name: Install ESP-IDF Tools
        run: |
          cd lib/esp-idf
          ./install.sh all

      # 编译固件
      - name: Build Firmware
        shell: bash
        run: |
          # 导入 ESP-IDF 环境变量
          source lib/esp-idf/export.sh
          
          # 运行构建脚本
          # 注意：这里我们手动指定了 make.py 参数
          # DISPLAY=all INDEV=all 表示启用所有驱动，你可以根据需要修改为特定驱动以减小体积
          python3 make.py esp32 \
            BOARD=${{ inputs.board }} \
            --flash-size=4 \
            DISPLAY=st7789 \
            INDEV="" \
            EXPANDER= "" \
            --no-scrub

      # 上传构建产物
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ inputs.board }}-${{ inputs.micropython_version }}-lvgl${{ inputs.lvgl_version }}
          path: build/
