name: Build ESP32-C3 Legacy Firmware

on:
  workflow_dispatch:

jobs:
  build-c3:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libffi-dev git python3-pip
          pip3 install esptool

      - name: Setup MicroPython (v1.23.0) and LVGL (v9.2)
        run: |
          # 初始化 MicroPython 和 LVGL
          git submodule update --init --recursive lib/micropython
          git submodule update --init --recursive lib/lvgl
          
          # 切换 MicroPython 到 v1.23.0
          cd lib/micropython
          git fetch --tags
          git checkout v1.23.0
          git submodule update --init --recursive lib/berkeley-db-1.xx
          git submodule update --init --recursive lib/mbedtls
          git submodule update --init --recursive lib/micropython-lib
          cd ../..

          # 切换 LVGL 到 release/v9.2
          cd lib/lvgl
          git fetch --tags
          git checkout release/v9.2
          cd ../..

      - name: Setup ESP-IDF v5.2.2
        run: |
          # 关键修改：删除 submodule 占位符，手动克隆指定版本
          rm -rf lib/esp-idf
          echo "Cloning ESP-IDF v5.2.2..."
          git clone -b v5.2.2 --recursive --depth 1 https://github.com/espressif/esp-idf.git lib/esp-idf
          
          # 安装工具链
          cd lib/esp-idf
          ./install.sh all
          cd ../..

      - name: Patch Builder Script for IDF v5.2.2
        run: |
          # 将构建脚本中的版本检查从 5.5.1 改为 5.2.2
          sed -i "s/IDF_VER = '5.5.1'/IDF_VER = '5.2.2'/g" builder/esp32.py
          # 验证修改
          grep "IDF_VER =" builder/esp32.py

      - name: Build Firmware for ESP32-C3
        shell: bash
        run: |
          export IDF_PATH=$(pwd)/lib/esp-idf
          source $IDF_PATH/export.sh
          
          # 编译命令
          python3 make.py esp32 \
            BOARD=ESP32_GENERIC_C3 \
            DISPLAY=st7789 \
            INDEV=all \
            --flash-size=4 \
            --optimize-size

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: micropython-lvgl-esp32c3-st7789
          path: build/*.bin
